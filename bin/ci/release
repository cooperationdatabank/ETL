#!/bin/bash


echo ${CI_COMMIT_MESSAGE} | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$' && [ "${CI_BUILD_REF_NAME}" = "master" ] && echo "Skipping version builds on the master branche to avoid the pipeline doing the same work twice" && exit;


echo "Releasing for build ref ${CI_BUILD_REF_NAME}"
if [ "${CI_BUILD_REF_NAME}" = "master" ]; then
  VERSION_TAG="latest"
elif echo "${CI_BUILD_REF_NAME}" | grep -q "^v-*"; then
  VERSION_TAG=${CI_BUILD_REF_NAME:2}
else
  echo "Not sure where to push this image. Assuming a feature branch"
  VERSION_TAG="feature-${CI_BUILD_REF_NAME}"
fi

DOCKER_IMAGE="triply/etl-coda"
docker tag ${DOCKER_IMAGE} ${DOCKER_IMAGE}:${VERSION_TAG}
echo "Pushing ${DOCKER_IMAGE}:${VERSION_TAG}"
echo "Note: If CI pipeline fails, it might be because the image is not created yet on docker hub, or that the CI user is not allowed to write to this docker image"
docker push ${DOCKER_IMAGE}:${VERSION_TAG}
